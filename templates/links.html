<!doctype html>
<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{modules/layout :: html(title = '友链'+'-'+${site.title},htmlType = links,header = null,leftSidebar = true,content = ~{::content}, head = null, footer = null)}"
>
  <th:block th:fragment="content">
    <body>
      <div id="Joe">
        <th:block th:replace="~{modules/macro/navbar :: navbar}" />
        <!--          首页大图-->
        <th:block th:if="${theme.config.beauty.enable_big_banner}">
          <th:block th:replace="~{modules/macro/big_banner :: big_banner(${title})}" />
        </th:block>
        <div
          class="joe_container joe_main_container page-journals"
          th:classappend="|${theme.config.theme.enable_show_in_up ? 'animated showInUp':''} ${theme.config.aside.aside_position == 'left' ? 'revert':''}|"
        >
          <div class="joe_main">
            <div
              class="joe_detail"
              th:with="bgColorArray=${#strings.arraySplit('linear-gradient(-90deg, #29bdd9 0%, #276ace 100%)@ linear-gradient(to right, #ff9569 0%, #e92758 100%)@ linear-gradient(to right, #a1c4fd 0%, #c2e9fb 100%)@ linear-gradient(to right, #f6d365 0%, #fda085 100%)@ linear-gradient(to right, #30cfd0 0%, #330867 100%)@ linear-gradient(to right, #fa709a 0%, #fee140 100%)@ linear-gradient(to right, #a8edea 0%, #fed6e3 100%)@ linear-gradient(to right, #fddb92 0%, #d1fdff 100%)@ linear-gradient(to right, #ebc0fd 0%, #d9ded8 100%),  linear-gradient(to right, #e4afcb 0%, #b8cbb8 0%, #b8cbb8 0%, #e2c58b 30%, #c2ce9c 64%, #7edbdc 100%)@ linear-gradient(to right, #ebbba7 0%, #cfc7f8 100%)@ linear-gradient(to right, #eea2a2 0%, #bbc1bf 19%, #57c6e1 42%, #b49fda 79%, #7ac5d8 100%)@ linear-gradient(to top, #09203f 0%, #537895 100%)@ linear-gradient(to right, #a8caba 0%, #5d4157 100%)@ linear-gradient(-60deg, #16a085 0%, #f4d03f 100%)@ linear-gradient(to right, #3b41c5 0%, #a981bb 49%, #ffc8a9 100%)@ linear-gradient(to right, #0fd850 0%, #f9f047 100%)','@')}">
              <h1 class="joe_detail__title txt-shadow">[[${theme.config.links.links_title}]]</h1>
              <article
                class="joe_detail__article animated fadeIn"
                th:with="colorArray=${#strings.arraySplit('#F8D800 ,#0396FF ,#EA5455 ,#7367F0 ,#32CCBC ,#F6416C ,#32B76E ,#9F44D3 ,#F55555 ,#736EFE ,#E96D71 ,#DE4313 ,#D939CD ,#4C83FF ,#F072B6 ,#C346C2 ,#5961F9 ,#FD6585 ,#5569E8 ,#FFC600 ,#FA742B ,#5151E5 ,#BB4E75 ,#FF52E5 ,#4DA037 ,#15D1E2 ,#F067B4 ,#F067B4 ,#ff9a9e ,#00f2fe ,#4facfe ,#f093fb ,#6fa3ef ,#bc99c4 ,#46c47c ,#f9bb3c ,#e8583d ,#f68e5f',',')}">
                <h3>友链列表<span class="totals"></span></h3>
                <div id="linksContainer"></div>

                <script>
                  // 定义颜色数组
                  const colorArray = ['#F8D800', '#0396FF', '#EA5455', '#7367F0', '#32CCBC', '#F6416C', '#32B76E', '#9F44D3', '#F55555', '#736EFE', '#E96D71', '#DE4313', '#D939CD', '#4C83FF', '#F072B6', '#C346C2', '#5961F9', '#FD6585', '#5569E8', '#FFC600', '#FA742B', '#5151E5', '#BB4E75', '#FF52E5', '#4DA037', '#15D1E2', '#F067B4', '#ff9a9e', '#00f2fe', '#4facfe', '#f093fb', '#6fa3ef', '#bc99c4', '#46c47c', '#f9bb3c', '#e8583d', '#f68e5f'];
                  
                  function renderLinks() {
                    // 从 plugin-links API 获取友链数据
                    fetch('/apis/api.plugin.halo.run/v1alpha1/plugins/PluginLinks/links')
                      .then(response => response.json())
                      .then(data => {
                        if (!data.items || data.items.length === 0) {
                          document.getElementById('linksContainer').innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">暂无友链数据</p>';
                          return;
                        }

                        // 按分组聚合数据
                        const groupMap = {};
                        data.items.forEach(link => {
                          // 检查是否显示
                          const linkEnableShow = link.metadata?.annotations?.['link_enable_show'] !== 'false';
                          if (!linkEnableShow) return;

                          // 获取分组（如果没有则为"默认分组"）
                          const groupName = link.spec?.group || '默认分组';
                          if (!groupMap[groupName]) {
                            groupMap[groupName] = {
                              links: [],
                              creationTimestamp: link.metadata?.creationTimestamp
                            };
                          }
                          groupMap[groupName].links.push(link);
                        });

                        if (Object.keys(groupMap).length === 0) {
                          document.getElementById('linksContainer').innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">暂无友链数据</p>';
                          return;
                        }

                        // 构建HTML
                        let html = '';
                        Object.entries(groupMap).forEach(([groupName, groupData]) => {
                          html += '<div class="links-group" data-link-group-sort-seq="0" data-link-group-create-time="' + (groupData.creationTimestamp || '') + '">';
                          html += '<h5>' + groupName + '</h5>';
                          html += '<ul class="joe_detail__friends evan-friends">';

                          groupData.links.forEach(link => {
                            const randomColor = colorArray[Math.floor(Math.random() * colorArray.length)];
                            const displayName = link.spec?.displayName || '无名友链';
                            const url = link.spec?.url || '#';
                            const logo = link.spec?.logo || '/themes/theme-Joe3/assets/img/default_links_logo.png';
                            const description = link.spec?.description || '';
                            const sortSeq = link.metadata?.annotations?.['link_sort_seq'] || '0';
                            const creationTime = link.metadata?.creationTimestamp || '';

                            html += '<li class="joe_detail__friends-item" data-link-sort-seq="' + sortSeq + '" data-link-create-time="' + creationTime + '">';
                            html += '<a class="contain" href="' + url + '" target="_blank" style="--fcolor: ' + randomColor + '" rel="noopener noreferrer">';
                            html += '<div class="evan-f-left"><div class="f-avatar">';
                            html += '<img width="40" height="40" class="avatar lazyload" src="/themes/theme-Joe3/assets/img/transparent-placeholder.png" data-src="' + logo + '" alt="' + displayName + '" onload="Joe.loadedPlaceholderReplaceImg(this, \'LinksImg\')" onerror="Joe.errorImg(this, \'LinksErrImg\')" />';
                            html += '</div></div>';
                            html += '<div class="evan-f-right">';
                            html += '<span class="title" style="--fcolor: ' + randomColor + '">';
                            html += '<span class="sub-text" title="' + displayName + '">' + displayName + '</span>';
                            html += '<svg t="1658027717181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="25920" width="200" height="200">';
                            html += '<path d="M0 0h1024v1024H0V0z" fill="#202425" opacity=".01" p-id="25921"></path>';
                            html += '<path d="M989.866667 512c0 263.918933-213.947733 477.866667-477.866667 477.866667S34.133333 775.918933 34.133333 512 248.081067 34.133333 512 34.133333s477.866667 213.947733 477.866667 477.866667z" fill="#FF7744" p-id="25922"></path>';
                            html += '<path d="M787.114667 339.285333a51.2 51.2 0 0 1 0 72.362667l-307.2 307.2a51.2 51.2 0 0 1-72.362667 0l-170.666667-170.666667a51.2 51.2 0 0 1 72.362667-72.362666L443.733333 610.235733l271.018667-271.018666a51.2 51.2 0 0 1 72.362667 0z" fill="#FFFFFF" p-id="25923"></path>';
                            html += '</svg></span>';
                            html += '<div class="content"><div class="desc" title="' + description + '">' + description + '</div></div>';
                            html += '</div></a></li>';
                          });

                          html += '</ul></div>';
                        });

                        document.getElementById('linksContainer').innerHTML = html;

                        // 排序逻辑
                        setTimeout(() => {
                          const joeDetailArticle = $('#Joe .page-journals .joe_detail__article');
                          const linksGroupEles = joeDetailArticle.find('.links-group');

                          linksGroupEles.sort((a, b) => {
                            const aSortSeq = parseInt($(a).data('link-group-sort-seq') || 0);
                            const bSortSeq = parseInt($(b).data('link-group-sort-seq') || 0);
                            if (!isNaN(bSortSeq) && !isNaN(aSortSeq)) {
                              if (bSortSeq > 0 && aSortSeq > 0) return bSortSeq > aSortSeq ? 1 : -1;
                              if (bSortSeq > 0) return 1;
                              if (aSortSeq > 0) return -1;
                            }
                            return 0;
                          });

                          joeDetailArticle.append(linksGroupEles);

                          linksGroupEles.each((_, linkGroupEle) => {
                            const linksUlEle = $(linkGroupEle).find('.joe_detail__friends');
                            const linksLiEles = linksUlEle.find('.joe_detail__friends-item');
                            linksLiEles.sort((a, b) => {
                              const aSortSeq = parseInt($(a).data('link-sort-seq') || 0);
                              const bSortSeq = parseInt($(b).data('link-sort-seq') || 0);
                              if (!isNaN(bSortSeq) && !isNaN(aSortSeq)) {
                                if (bSortSeq > 0 && aSortSeq > 0) return bSortSeq > aSortSeq ? 1 : -1;
                                if (bSortSeq > 0) return 1;
                                if (aSortSeq > 0) return -1;
                              }
                              return 0;
                            });
                            linksUlEle.append(linksLiEles);
                          });
                        }, 100);
                      })
                      .catch(error => {
                        console.error('加载友链失败:', error);
                        document.getElementById('linksContainer').innerHTML = '<p style="text-align: center; color: #ff6b6b; padding: 20px;">友链加载失败，请稍后重试</p>';
                      });
                  }

                  // 页面加载完毕后执行
                  if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', renderLinks);
                  } else {
                    renderLinks();
                  }
                </script>
              </article>

            </div>

            <th:block th:if="${theme.config.links.enable_links_comment}">
              <div class="joe_comment">
                <div class="joe_comment_box">
                  <div class="box_title">
                    <h2>评论区</h2>
                  </div>
                  <th:block
                    th:if="${theme.config.basic.comment_option == 'default'} or ${#strings.trim(theme.config.basic.waline.waline_serverURL) ==''}"
                  >
                    <halo:comment
                      group="plugin.halo.run"
                      kind="Plugin"
                      th:attr="name=${pluginName}"
                      colorScheme="document.documentElement.getAttribute('data-mode')"
                    />
                  </th:block>
                  <th:block
                    th:if="${theme.config.basic.comment_option == 'waline'} and ${#strings.trim(theme.config.basic.waline.waline_serverURL) !=''}"
                  >
                    <div id="waline"></div>
                    <style>
                      #waline .wl-count {
                        color: var(--routine);
                      }
                    </style>

                    <script type="module" th:inline="javascript">
                      import { init } from /*[[${theme.config.basic.waline.waline_js_comment}]]*/ '';

                      const waline_config_basic_jsonString =
                        /*[[${theme.config.basic.waline.waline_config_basic_json}]]*/ '';
                      const waline_config_basic_object = JSON.parse(
                        waline_config_basic_jsonString === null ||
                          waline_config_basic_jsonString.trim() === ''
                          ? '{}'
                          : waline_config_basic_jsonString.trim()
                      );

                      let waline_config_imageUpload_option =
                        /*[[${theme.config.basic.waline.waline_config_imageUpload_option}]]*/ '';
                      let imageUploader = 'true';
                      if (waline_config_imageUpload_option === 'lskypro') {
                        imageUploader = (file) => {
                          let lskypro_apiURL =
                            /*[[${theme.config.basic.waline.lskypro.lskypro_apiURL}]]*/ '';
                          let lskypro_apiTOKEN =
                            /*[[${theme.config.basic.waline.lskypro.lskypro_apiTOKEN}]]*/ '';

                          let formData = new FormData();
                          let headers = new Headers();

                          formData.append('file', file);
                          if (lskypro_apiTOKEN.trim() !== '') {
                            headers.append('Authorization', 'Bearer ' + lskypro_apiTOKEN.trim());
                          }
                          headers.append('Accept', 'application/json');

                          return fetch(lskypro_apiURL.trim(), {
                            method: 'POST',
                            headers: headers,
                            body: formData,
                          })
                            .then((resp) => resp.json())
                            .then((resp) => resp.data.links.url);
                        };
                      }

                      init({
                        el: '#waline',
                        dark: 'html[data-mode="dark"]',
                        serverURL: /*[[${theme.config.basic.waline.waline_serverURL}]]*/ '',
                        requiredMeta: ['nick', 'mail'],
                        imageUploader,
                        ...waline_config_basic_object,
                      });
                    </script>
                  </th:block>
                </div>
              </div>
            </th:block>
          </div>
          <th:block th:if="${theme.config.aside.enable_links_aside}">
            <th:block th:replace="~{modules/common/aside :: aside}" />
          </th:block>
        </div>
        <th:block th:replace="~{modules/common/actions :: actions}" />
        <th:block th:replace="~{modules/common/footer :: footer}" />
      </div>
      <th:block th:replace="~{modules/macro/tail :: tail}" />
    </body>
  </th:block>
</html>
